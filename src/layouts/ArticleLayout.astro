---
// src/layouts/ArticleLayout.astro
import BaseLayout from './BaseLayout.astro';
import { mapCategorySlug } from '../lib/slug';
import { supabase } from '../lib/supabase';
import { AdSlot } from '../components/ads/AdSlot.tsx';
import { LazyAdSlot } from '../components/ads/LazyAdSlot';
import Breadcrumb from '../components/Breadcrumb.astro';

export interface Props {
  article: {
    id: string;
    title: string;
    content: string;
    excerpt: string | null;
    slug: string;
    status: string;
    created_at: string;
    updated_at: string;
    cover_image_path: string | null;
    cover_image_alt: string | null;
    image_url?: string;
    reading_time?: number;
    author?: string;
    meta_description?: string;
    tags?: string[];
    categories?: any[];
    article_categories?: any[];
    sources?: any[];
  };
  relatedArticles?: any[];
}

const { article, relatedArticles = [] } = Astro.props;

// Helper pour générer l'URL d'un article
const getArticleUrl = (article: any) => {
  if (article?.article_categories?.[0]?.category?.slug) {
    return `/${article.article_categories[0].category.slug}/${article.slug}`;
  }
  return `/`;
};

// Récupérer les articles de la même catégorie
const firstCategory = article.article_categories?.[0]?.category;
let sameCategoryArticles: any[] = [];

if (firstCategory) {
  const { data: categoryArticles } = await supabase
    .from('articles')
    .select(`
      id,
      title,
      slug,
      excerpt,
      cover_image_path,
      cover_image_alt,
      reading_time,
      created_at,
      article_categories(category_id, category:categories(id, name, slug))
    `)
    .eq('status', 'approved')
    .neq('id', article.id)
    .order('created_at', { ascending: false })
    .limit(6);

  // Filtrer les articles de la même catégorie
  sameCategoryArticles = categoryArticles?.filter(art => 
    art.article_categories?.some((ac: any) => 
      ac?.category?.slug === firstCategory.slug
    )
  ) || [];
}

// Breadcrumb items - récupérer la première catégorie
// Fonction pour mapper les slugs de base de données vers les slugs d'URL
// (mapping centralisé déplacé vers lib/slug.ts)

const breadcrumbItems = firstCategory
  ? [
      { label: 'Accueil', href: '/' },
      { label: firstCategory.name, href: `/${mapCategorySlug(firstCategory.slug)}` },
      { label: article.title }
    ]
  : [
      { label: 'Accueil', href: '/' },
      { label: article.title }
    ];

// Métadonnées SEO
const title = article.title;
const description = article.meta_description || article.excerpt || `${article.title} - Geeks Patrol`;
const image = article.cover_image_path || article.image_url || '/og-image.png';
const url = `${Astro.site}${Astro.url.pathname}`;
const publishedTime = new Date(article.created_at).toISOString();
const modifiedTime = new Date(article.updated_at).toISOString();

// Structured Data (JSON-LD)
const structuredData = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": title,
  "description": description,
  "image": image,
  "datePublished": publishedTime,
  "dateModified": modifiedTime,
  "author": {
    "@type": "Person",
    "name": article.author || "Geeks Patrol"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Geeks Patrol",
    "logo": {
      "@type": "ImageObject",
      "url": `${Astro.site}/logo.png`
    }
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": url
  }
};
---

<BaseLayout title={`${title} - Geeks Patrol`} description={description} image={image}>
  <!-- SEO Meta Tags supplémentaires pour les articles -->
  <meta name="keywords" content={article.tags?.join(', ') || 'tech, geek, actualité'} />
  <meta name="author" content={article.author || 'Geeks Patrol'} />
  <meta name="robots" content="index, follow" />

  <!-- Open Graph supplémentaires pour les articles -->
  <meta property="og:type" content="article" />
  <meta property="og:site_name" content="Geeks Patrol" />
  <meta property="article:published_time" content={publishedTime} />
  <meta property="article:modified_time" content={modifiedTime} />
  <meta property="article:author" content={article.author || 'Geeks Patrol'} />

  <!-- Canonical URL -->
  <link rel="canonical" href={url} />

  <!-- Structured Data -->
  <script type="application/ld+json" set:html={JSON.stringify(structuredData)}></script>

  <!-- Article Content -->
  <div class="min-h-screen">
    <!-- Breadcrumb -->
    <div class="container mx-auto px-4 pt-8 pb-4">
      <Breadcrumb items={breadcrumbItems} />
    </div>
    
    <!-- Layout 3 colonnes : AdCards | Contenu | Navigation -->
    <div class="container mx-auto px-6 py-8 max-w-[1400px]">
  <div class="grid grid-cols-1 lg:grid-cols-[200px_1fr_260px] gap-4 lg:gap-6 xl:gap-8">
        
        <!-- Colonne gauche : AdCards + Actions (cachée sur mobile, visible sur desktop) -->
        <aside class="hidden lg:block">
          <div class="sticky top-24 space-y-8">
            <!-- Ad Card 1 -->
            <div class="w-full flex justify-center">
              <LazyAdSlot
                slot="1234567890"
                format="vertical"
                style={{ width: '200px', height: '600px' }}
                position="sidebar"
                client:load
              />
            </div>
            
            <!-- Ad Card 2 -->
            <div class="w-full flex justify-center">
              <LazyAdSlot
                slot="2345678901"
                format="rectangle"
                style={{ width: '200px', height: '200px' }}
                position="sidebar"
                client:load
              />
            </div>
          </div>
        </aside>

        <!-- Colonne centrale : Contenu de l'article -->
        <article class="min-w-0">
          
          <!-- Pub en haut (mobile uniquement) -->
          <div class="mb-8 flex justify-center lg:hidden">
            <LazyAdSlot
              slot="1234567890"
              format="horizontal"
              style={{ width: '320px', height: '100px' }}
              position="top"
              client:load
            />
          </div>

      <!-- Article Header -->
      <header class="mb-8">
        <div class="flex flex-wrap gap-2 mb-4">
          {article.categories?.map((cat: any) => (
            <a 
              href={`/category/${cat.category?.slug}`} 
              class="px-3 py-1 rounded-full text-sm font-medium transition-colors"
              style="background: var(--bg-secondary); color: var(--accent);"
            >
              {cat.category?.name}
            </a>
          ))}
        </div>
        
        <h1 class="text-4xl md:text-5xl font-bold mb-4 leading-tight" style="color: var(--text-primary);">
          {article.title}
        </h1>
        
        <div class="flex flex-wrap items-center gap-4 mb-6" style="color: var(--text-secondary);">
          {article.reading_time && (
            <span>{article.reading_time} min de lecture</span>
          )}
          
          <time datetime={publishedTime}>
            {new Date(article.created_at).toLocaleDateString('fr-FR', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
          
          {article.author && (
            <span>Par {article.author}</span>
          )}
        </div>
        
        {article.cover_image_path && (
          <div class="mb-8">
            <img 
              src={article.cover_image_path} 
              alt={article.cover_image_alt || article.title}
              class="w-full h-64 md:h-96 object-cover rounded-lg shadow-lg"
            />
          </div>
        )}
      </header>

      <!-- Article Content -->
      <div class="prose prose-lg dark:prose-invert max-w-none mb-4">
        <!-- Contenu de l'article -->
        <div set:html={article.content} />
        
        <!-- Pub au milieu du contenu -->
        <div class="my-6 flex justify-center">
          <LazyAdSlot 
            slot="0987654321" 
            format="rectangle" 
            style={{ width: '300px', height: '250px' }} 
            position="middle" 
            client:load 
          />
        </div>
        
        <slot />
      </div>

      <!-- Article Footer -->
      <footer class="pt-6" style="border-top: 1px solid var(--text-secondary);">
        <!-- Tags -->
        {article.tags && article.tags.length > 0 && (
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">Tags</h3>
            <div class="flex flex-wrap gap-2">
              {article.tags.map((tag: string) => (
                <span class="px-3 py-1 rounded-full text-sm" style="background: var(--bg-secondary); color: var(--text-secondary);">
                  #{tag}
                </span>
              ))}
            </div>
          </div>
        )}

        <!-- Sources -->
        {article.sources && article.sources.length > 0 && (
          <div class="mb-6">
            <h3 class="text-lg font-semibold mb-3" style="color: var(--text-primary);">Sources</h3>
            <div class="flex flex-wrap gap-3">
              {article.sources.map((source: any) => (
                <a
                  href={source.url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 px-3 py-2 text-sm rounded-md transition-colors hover:opacity-80"
                  style="background: var(--bg-secondary); color: var(--accent); border: 1px solid var(--border-light);"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                  </svg>
                  {source.name}
                </a>
              ))}
            </div>
          </div>
        )}

        <!-- Pub en bas (mobile uniquement) -->
        <div class="mb-8 flex justify-center lg:hidden">
          <LazyAdSlot 
            slot="1357924680" 
            format="horizontal" 
            style={{ width: '320px', height: '100px' }} 
            position="bottom" 
            client:load 
          />
        </div>

        <!-- Partage -->
        <div class="flex justify-center gap-4 mb-8">
          <button 
            class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition-colors shadow-md"
            onclick={`navigator.share({ title: '${title}', url: '${url}' })`}
          >
            <i class="fas fa-share-alt"></i>
            Partager
          </button>
        </div>
      </footer>
    </article>

        <!-- Colonne droite : Navigation articles similaires -->
        <aside class="hidden lg:block">
          <div class="sticky top-24 space-y-6">
            {/* Articles de la même catégorie */}
            {sameCategoryArticles.length > 0 && (
              <div class="rounded-xl shadow-lg overflow-hidden" style="background: var(--bg-primary); border: 1px solid var(--border-light);">
                <div class="px-4 py-3 flex items-center justify-center">
                  <h3 class="text-sm font-bold uppercase tracking-wide text-center" style="color: var(--accent);">
                    {firstCategory?.name}
                  </h3>
                </div>
                <div style="border-top: 1px solid var(--border-light);">
                  {sameCategoryArticles.map((relatedArticle: any) => (
                    <a 
                      href={getArticleUrl(relatedArticle)} 
                      class="block group transition-colors"
                      style="border-bottom: 1px solid var(--border-light);"
                      onmouseenter="this.style.background='var(--bg-secondary)'"
                      onmouseleave="this.style.background='transparent'"
                    >
                      <div class="flex gap-3 p-4">
                        {relatedArticle.cover_image_path ? (
                          <img 
                            src={relatedArticle.cover_image_path} 
                            alt={relatedArticle.cover_image_alt || relatedArticle.title}
                            class="w-24 h-16 rounded object-cover flex-shrink-0"
                          />
                        ) : (
                          <div class="w-24 h-16 rounded bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-file-alt w-8 h-8 text-white opacity-80"></i>
                          </div>
                        )}
                        <div class="flex-1 min-w-0">
                          <h4 class="text-sm font-semibold transition-colors line-clamp-3 leading-snug mb-1" style="color: var(--text-primary);">
                            {relatedArticle.title}
                          </h4>
                          <div class="flex items-center gap-2">
                            {relatedArticle.reading_time && (
                              <span class="text-xs font-medium" style="color: var(--text-secondary);">
                                {relatedArticle.reading_time} min
                              </span>
                            )}
                            <time class="text-xs font-medium ml-auto" style="color: var(--text-secondary);" datetime={relatedArticle.created_at}>
                              {new Date(relatedArticle.created_at).toLocaleDateString('fr-FR', {
                                day: 'numeric',
                                month: 'short'
                              })}
                            </time>
                          </div>
                        </div>
                      </div>
                    </a>
                  ))}
                </div>
                
                {firstCategory && (
                  <div class="px-4 py-3" style="background: var(--bg-secondary);">
                    <a 
                      href={`/${mapCategorySlug(firstCategory.slug)}`}
                      class="block text-center text-sm font-bold transition-colors tracking-wide"
                      style="color: var(--accent);"
                    >
                      Voir tous les articles →
                    </a>
                  </div>
                )}
              </div>
            )}

            {/* Pub sidebar droite (desktop uniquement) */}
            <div class="hidden xl:block">
              <LazyAdSlot
                slot="3456789012"
                format="rectangle"
                style={{ width: '300px', height: '250px' }}
                position="sidebar"
                client:load
              />
            </div>
          </div>
        </aside>

      </div>
    </div>
  </div>
</BaseLayout>