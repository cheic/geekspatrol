---
import { PRIMARY_NAV, buildHref } from '../config/navigation';
import ThemeToggle from './ThemeToggle.astro';

// Get current URL for active state
const currentUrl = Astro.url.pathname;
---

<header class="sticky top-0 z-50 border-b border-slate-200 dark:border-slate-700 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md shadow-sm">
  <div class="container mx-auto px-4">
  <div class="flex h-14 items-center justify-between gap-4">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-2 text-2xl font-bold text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300 transition-colors">
        <span>Geeks Patrol</span>
      </a>

      <!-- Navigation desktop -->
      <nav class="hidden lg:flex items-center gap-1">
        {PRIMARY_NAV.map(item => {
          const href = buildHref(item);
          const isActive = currentUrl === href || (href !== '/' && currentUrl.startsWith(href));
          return (
          <a 
            href={href} 
            class={`group relative px-4 py-2 rounded-lg text-sm font-medium transition-all ${
              isActive 
                ? 'text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/50' 
                : 'text-slate-700 dark:text-slate-300 hover:text-indigo-600 dark:hover:text-indigo-400 hover:bg-slate-100 dark:hover:bg-slate-800'
            }`}
            title={item.description}
          >
            <span class="flex items-center gap-2">
              {item.label}
            </span>
            <!-- Underline animation -->
            <span class={`absolute bottom-0 left-0 h-0.5 bg-indigo-600 dark:bg-indigo-400 transition-all duration-300 ${
              isActive ? 'w-full' : 'w-0 group-hover:w-full'
            }`}></span>
          </a>
        )})}
      </nav>

      <!-- Actions -->
      <div class="flex items-center gap-3">
        <!-- Search button -->
        <button 
          id="search-toggle"
          class="p-2 rounded-lg text-indigo-600 dark:text-slate-400 hover:text-indigo-700 dark:hover:text-indigo-300 bg-slate-50 dark:bg-transparent hover:bg-slate-100 dark:hover:bg-slate-800 border border-indigo-200 dark:border-transparent transition-colors"
          aria-label="Rechercher"
          title="Rechercher (Ctrl/Cmd+K)"
        >
          <i class="fas fa-search w-5 h-5"></i>
        </button>

        <!-- Theme toggle (icon only, no background) -->
        <ThemeToggle />

        <!-- Mobile menu button -->
        <button 
          id="mobile-menu-toggle"
          class="lg:hidden p-2 rounded-lg text-indigo-600 dark:text-slate-400 hover:text-indigo-700 dark:hover:text-indigo-300 bg-slate-50 dark:bg-transparent hover:bg-slate-100 dark:hover:bg-slate-800 border border-indigo-200 dark:border-transparent transition-colors"
          aria-label="Menu mobile"
        >
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile menu -->
  <div id="mobile-menu" class="hidden lg:hidden border-t border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900">
  <nav class="container mx-auto px-4 py-3 space-y-2">
      {PRIMARY_NAV.map(item => {
        const href = buildHref(item);
        const isActive = currentUrl === href || (href !== '/' && currentUrl.startsWith(href));
        return (
        <a 
          href={href} 
          class={`block px-4 py-3 rounded-lg transition-all ${
            isActive 
              ? 'bg-indigo-50 dark:bg-indigo-900/50 text-indigo-600 dark:text-indigo-400' 
              : 'text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 hover:text-indigo-600 dark:hover:text-indigo-400'
          }`}
        >
          <div class="font-medium">{item.label}</div>
          {item.description && (
            <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">{item.description}</div>
          )}
        </a>
      )})}
    </nav>
  </div>

  <!-- Search overlay -->
  <div id="search-overlay" class="hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm">
  <div class="container mx-auto px-4 pt-16">
      <div class="max-w-2xl mx-auto">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl overflow-hidden">
          <div class="flex items-center gap-3 px-6 py-4 border-b border-slate-200 dark:border-slate-700">
            <i class="fas fa-search w-5 h-5 text-indigo-500 dark:text-indigo-400"></i>
            <input 
              type="text" 
              id="search-input"
              placeholder="Rechercher des articles, catégories..."
              class="flex-1 bg-transparent text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none text-lg"
              autofocus
            />
            <button id="search-close" class="p-2 rounded-lg text-indigo-600 dark:text-slate-400 hover:text-indigo-700 dark:hover:text-indigo-300 bg-slate-50 dark:bg-transparent hover:bg-slate-100 dark:hover:bg-slate-800 border border-indigo-200 dark:border-transparent transition-colors" aria-label="Fermer la recherche">
              <i class="fas fa-times w-5 h-5"></i>
            </button>
          </div>
          <div id="search-results" class="p-6 max-h-96 overflow-y-auto">
            <div class="text-center py-12">
              <i class="fas fa-search w-16 h-16 mx-auto mb-4 text-slate-300 dark:text-slate-600"></i>
              <p class="text-slate-500 dark:text-slate-400">Recherchez des articles par titre, catégorie ou mot-clé</p>
              <p class="text-sm text-slate-400 dark:text-slate-500 mt-2">Tapez au moins 2 caractères pour commencer</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  // Mobile menu toggle
  const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  
  mobileMenuToggle?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden');
  });

  // Search overlay
  const searchToggle = document.getElementById('search-toggle');
  const searchOverlay = document.getElementById('search-overlay');
  const searchClose = document.getElementById('search-close');
  const searchInput = document.getElementById('search-input');
  
  const openSearch = () => {
    searchOverlay?.classList.remove('hidden');
    setTimeout(() => searchInput?.focus(), 100);
  };
  
  const closeSearch = () => {
    searchOverlay?.classList.add('hidden');
  };
  
  searchToggle?.addEventListener('click', openSearch);
  searchClose?.addEventListener('click', closeSearch);
  
  // Close search with Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !searchOverlay?.classList.contains('hidden')) {
      closeSearch();
    }
    // Open search with Ctrl+K or Cmd+K
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      openSearch();
    }
  });
  
  // Close search when clicking outside
  searchOverlay?.addEventListener('click', (e) => {
    if (e.target === searchOverlay) {
      closeSearch();
    }
  });

    // Simple search functionality (to be enhanced later)
    let searchTimeout: ReturnType<typeof setTimeout>;
    
    // Fonction pour échapper le HTML et prévenir les attaques XSS
    function escapeHtml(text: string): string {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    searchInput?.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value.trim();
      const resultsDiv = document.getElementById('search-results');
      
      if (!resultsDiv) return;
      
      // Clear previous timeout
      clearTimeout(searchTimeout);
      
      if (query.length === 0) {
        resultsDiv.innerHTML = `
          <div class="text-center py-12">
            <i class="fas fa-search w-16 h-16 mx-auto mb-4 text-slate-300 dark:text-slate-600"></i>
            <p class="text-slate-500 dark:text-slate-400">Recherchez des articles par titre, catégorie ou mot-clé</p>
            <p class="text-sm text-slate-400 dark:text-slate-500 mt-2">Tapez au moins 2 caractères pour commencer</p>
          </div>
        `;
        return;
      }
      
      if (query.length < 2) {
        resultsDiv.innerHTML = `
          <div class="text-center py-8">
            <p class="text-slate-500 dark:text-slate-400">Tapez au moins 2 caractères...</p>
          </div>
        `;
        return;
      }
      
      // Show loading state
      resultsDiv.innerHTML = `
        <div class="text-center py-8">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 dark:border-indigo-400"></div>
          <p class="text-slate-500 dark:text-slate-400 mt-4">Recherche en cours...</p>
        </div>
      `;
      
      // Debounce search
      searchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/api/search.json?q=${encodeURIComponent(query)}`);
          const results = await response.json();
          
          if (results.length === 0) {
            resultsDiv.innerHTML = `
              <div class="text-center py-12">
                <i class="fas fa-search w-16 h-16 mx-auto mb-4 text-slate-300 dark:text-slate-600"></i>
                <p class="text-slate-500 dark:text-slate-400">Aucun résultat trouvé pour "${escapeHtml(query)}"</p>
                <p class="text-sm text-slate-400 dark:text-slate-500 mt-2">Essayez avec d'autres mots-clés</p>
              </div>
            `;
            return;
          }
          
          resultsDiv.innerHTML = `
            <div class="space-y-3">
              <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">${results.length} résultat${results.length > 1 ? 's' : ''} trouvé${results.length > 1 ? 's' : ''}</p>
              ${results.map((article: any) => `
                <a href="${escapeHtml(article.url)}" class="block p-4 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors group">
                  <div class="flex items-start gap-3">
                    ${article.cover_image_path 
                      ? `<img src="${escapeHtml(article.cover_image_path)}" alt="${escapeHtml(article.title)}" class="w-16 h-16 rounded-lg object-cover flex-shrink-0" />`
                      : `<div class="w-16 h-16 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                           <i class="fas fa-file-alt w-8 h-8 text-white opacity-80"></i>
                         </div>`
                    }
                    <div class="flex-1 min-w-0">
                      <h3 class="font-semibold text-slate-900 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors line-clamp-2">${escapeHtml(article.title)}</h3>
                      ${article.excerpt ? `<p class="text-sm text-slate-600 dark:text-slate-400 mt-1 line-clamp-2">${escapeHtml(article.excerpt)}</p>` : ''}
                      <div class="flex items-center gap-2 mt-2 text-xs text-slate-500 dark:text-slate-400">
                        ${article.category ? `<span class="px-2 py-0.5 bg-indigo-100 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded">${escapeHtml(article.category)}</span>` : ''}
                        ${article.reading_time ? `<span>${escapeHtml(String(article.reading_time))} min</span>` : ''}
                      </div>
                    </div>
                  </div>
                </a>
              `).join('')}
            </div>
          `;
        } catch (error) {
          resultsDiv.innerHTML = `
            <div class="text-center py-8">
              <p class="text-red-500 dark:text-red-400">Erreur lors de la recherche</p>
            </div>
          `;
        }
      }, 300);
    });
</script>