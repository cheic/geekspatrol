---
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleCard from '../components/ArticleCard';
import Breadcrumb from '../components/Breadcrumb.astro';
import { LazyAdSlot } from '../components/ads/LazyAdSlot';
import { supabase } from '../lib/supabase';
import { mapCategorySlug, CATEGORY_DISPLAY } from '../lib/slug';

// Récupérer le paramètre de catégorie depuis l'URL
const { category } = Astro.params;

// Map des catégories avec leurs informations
const categoryInfo: Record<string, { title: string; description: string; slug: string }> = Object.fromEntries(
  Object.entries(CATEGORY_DISPLAY).map(([slug, info]) => [slug, { ...info, slug }])
);

// Vérifier si la catégorie existe
const currentCategory = categoryInfo[category || ''];
if (!currentCategory) {
  // Retourne directement un statut 404 sans redirection supplémentaire
  return new Response('Catégorie introuvable', { status: 404 });
}

// Pagination
const ARTICLES_PER_PAGE = 12;
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');

// Récupérer tous les articles
const { data: articles } = await supabase
  .from('articles')
  .select(`
    id, title, slug, excerpt, cover_image_path, cover_image_alt, 
    created_at, status, reading_time, seo_keywords,
    article_categories(category_id, category:categories(id, name, slug))
  `)
  .eq('status', 'approved')
  .order('created_at', { ascending: false });

if (articles && articles.length > 0) {
  articles.forEach((article, index) => {
  });
}

// Filtrer les articles par catégorie
const allCategoryArticles = articles?.filter(article => {
  // Articles de la catégorie principale
  let hasCategory = false;
  if (article.article_categories && Array.isArray(article.article_categories)) {
    hasCategory = article.article_categories.some((ac: any) =>
      ac?.category?.slug === currentCategory.slug
    );
  }

  // Mots-clés associés à chaque catégorie
  const categoryKeywords: Record<string, string[]> = {
    'ia': [
      'intelligence artificielle', 'ia', 'machine learning', 'chatgpt', 'openai', 'gpt',
      'deep learning', 'neural', 'robotique', 'automatisation', 'algorithme'
    ],
    'mobile': [
      'smartphone', 'mobile', 'android', 'ios', 'iphone', 'samsung', 'application',
      'app store', 'google play', 'pliable', 'foldable', 'téléphone'
    ],
    'tech': [
      'ordinateur', 'hardware', 'logiciel', 'innovation', 'gadget', 'voiture électrique',
      'internet', 'réseau', 'cloud', 'cybersécurité', 'blockchain', 'gaming', 'vr', 'ar'
    ]
  };

  // Pour les catégories définies, inclure aussi les articles avec des mots-clés associés
  if (categoryKeywords[currentCategory.slug]) {
    const seoKeywords = article.seo_keywords || '';
    
    if (!seoKeywords || seoKeywords.trim() === '') {
      return hasCategory; // Retourner seulement si l'article a la catégorie
    }
    
    const keywords: string[] = seoKeywords.toLowerCase().split(',').map((k: string) => k.trim());
    const relatedKeywords = categoryKeywords[currentCategory.slug];

    const hasRelatedKeywords = keywords.some((keyword: string) =>
      relatedKeywords.some((related: string) =>
        keyword.includes(related) || related.includes(keyword)
      )
    );

    return hasCategory || hasRelatedKeywords;
  }

  return hasCategory;
}) || [];


// Calculer la pagination
const totalArticles = allCategoryArticles.length;
const totalPages = Math.ceil(totalArticles / ARTICLES_PER_PAGE);
const startIndex = (currentPage - 1) * ARTICLES_PER_PAGE;
const endIndex = startIndex + ARTICLES_PER_PAGE;
const categoryArticles = allCategoryArticles.slice(startIndex, endIndex);

// Générer les numéros de pages à afficher
const getPageNumbers = () => {
  const pages = [];
  const maxPagesToShow = 5;
  
  if (totalPages <= maxPagesToShow) {
    for (let i = 1; i <= totalPages; i++) {
      pages.push(i);
    }
  } else {
    if (currentPage <= 3) {
      for (let i = 1; i <= 4; i++) pages.push(i);
      pages.push('...');
      pages.push(totalPages);
    } else if (currentPage >= totalPages - 2) {
      pages.push(1);
      pages.push('...');
      for (let i = totalPages - 3; i <= totalPages; i++) pages.push(i);
    } else {
      pages.push(1);
      pages.push('...');
      for (let i = currentPage - 1; i <= currentPage + 1; i++) pages.push(i);
      pages.push('...');
      pages.push(totalPages);
    }
  }
  
  return pages;
};

const pageNumbers = getPageNumbers();

// Breadcrumb items
const breadcrumbItems = [
  { label: 'Accueil', href: '/' },
  { label: currentCategory.title }
];
---

<BaseLayout 
  title={`${currentCategory.title} - GeeksPatrol`}
  description={currentCategory.description}
>
  <!-- Google Analytics Category View Tracking -->
  {import.meta.env.GA_MEASUREMENT_ID && (
    <script define:vars={{ 
      categoryName: currentCategory.title, 
      categorySlug: currentCategory.slug 
    }}>
      import { trackCategoryView } from '../lib/analytics';
      
      // Track category view on page load
      trackCategoryView(categoryName, categorySlug);
    </script>
  )}
  <section class="container mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <div class="mb-8">
      <Breadcrumb items={breadcrumbItems} />
    </div>

    <!-- En-tête de catégorie -->
    <div class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold mb-2 text-slate-900 dark:text-white">
        {currentCategory.title}
      </h1>
      <p class="text-base text-slate-600 dark:text-slate-400">
        {currentCategory.description}
      </p>
      {totalArticles > 0 && (
        <p class="text-sm text-slate-500 dark:text-slate-400 mt-2">
          {totalArticles} article{totalArticles > 1 ? 's' : ''}
        </p>
      )}
    </div>

    <!-- Publicité Google AdSense - Bandeau supérieur -->
    <div class="mb-12">
      <LazyAdSlot slot="category-top-banner" format="horizontal" />
    </div>

    {categoryArticles.length > 0 ? (
      <>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
          {categoryArticles.map((article: any, index: number) => {
            // Insérer une pub après chaque 6 articles
            const showAd = (index + 1) % 6 === 0;
            
            return (
              <>
                <ArticleCard article={article} client:load />
                
                {showAd && (
                  <div class="md:col-span-2 lg:col-span-3">
                    <LazyAdSlot slot={`category-feed-ad-${index}`} format="horizontal" />
                  </div>
                )}
              </>
            );
          })}
        </div>

        {/* Publicité Google AdSense - Bandeau inférieur */}
        <div class="mb-12">
          <LazyAdSlot slot="category-bottom-banner" format="horizontal" />
        </div>

        {/* Pagination */}
        {totalPages > 1 && (
          <nav class="flex justify-center items-center gap-2 mt-12" aria-label="Pagination">
            {/* Bouton Précédent */}
            {currentPage > 1 ? (
              <a
                href={`/${category}?page=${currentPage - 1}`}
                class="px-4 py-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                aria-label="Page précédente"
              >
                ← Précédent
              </a>
            ) : (
              <span class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-400 dark:text-slate-600 cursor-not-allowed">
                ← Précédent
              </span>
            )}

            {/* Numéros de page */}
            <div class="hidden sm:flex gap-2">
              {pageNumbers.map((pageNum) => (
                pageNum === '...' ? (
                  <span class="px-4 py-2 text-slate-500 dark:text-slate-400">
                    ...
                  </span>
                ) : (
                  <a
                    href={`/${category}?page=${pageNum}`}
                    class={`px-4 py-2 rounded-lg border transition-colors ${
                      currentPage === pageNum
                        ? 'bg-[#00bcd4] border-[#00bcd4] text-white font-semibold'
                        : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700'
                    }`}
                    aria-label={`Page ${pageNum}`}
                    aria-current={currentPage === pageNum ? 'page' : undefined}
                  >
                    {pageNum}
                  </a>
                )
              ))}
            </div>

            {/* Indicateur mobile */}
            <span class="sm:hidden px-4 py-2 text-slate-600 dark:text-slate-400">
              Page {currentPage} / {totalPages}
            </span>

            {/* Bouton Suivant */}
            {currentPage < totalPages ? (
              <a
                href={`/${category}?page=${currentPage + 1}`}
                class="px-4 py-2 rounded-lg bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors"
                aria-label="Page suivante"
              >
                Suivant →
              </a>
            ) : (
              <span class="px-4 py-2 rounded-lg bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-400 dark:text-slate-600 cursor-not-allowed">
                Suivant →
              </span>
            )}
          </nav>
        )}
      </>
    ) : (
      <div class="text-center py-16">
        <p class="text-slate-500 dark:text-slate-400 text-lg">
          Aucun article disponible pour le moment
        </p>
      </div>
    )}
  </section>
</BaseLayout>
