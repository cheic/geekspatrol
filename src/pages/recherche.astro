---
import BaseLayout from '../layouts/BaseLayout.astro';
import { supabase } from '../lib/supabase';
import { mapCategorySlug } from '../lib/slug';

const q = Astro.url.searchParams.get('q')?.trim() || '';
let results: any[] = [];
let errorMsg: string | null = null;

if (q) {
  try {
    // Construire un pattern ilike sécurisé (échapper % _ de base)
    const pattern = `%${q.replace(/[%_]/g, s => '\\' + s)}%`;
    // Supabase OR filter: titre, excerpt, seo_keywords
    const { data, error } = await supabase
      .from('articles')
      .select(`id, title, slug, excerpt, created_at, seo_keywords, article_categories(category:categories(slug,name))`)
      .eq('status', 'approved')
      .or(`title.ilike.${pattern},excerpt.ilike.${pattern},seo_keywords.ilike.${pattern}`)
      .order('created_at', { ascending: false })
      .limit(30);

    if (error) {
      errorMsg = 'Erreur lors de la recherche';
    } else {
      results = data || [];
    }
  } catch (e) {
    errorMsg = 'Erreur inattendue';
  }
}

const pageTitle = q ? `Recherche: ${q} - Geeks Patrol` : 'Recherche - Geeks Patrol';
const pageDesc = q ? `Résultats pour la requête "${q}"` : 'Recherchez dans les articles Geeks Patrol';
---

<BaseLayout title={pageTitle} description={pageDesc}>
  <section class="container mx-auto px-4 py-12">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-6" style="color: var(--text-primary);">Recherche</h1>
      <form method="GET" action="/recherche" class="flex flex-col sm:flex-row gap-3 mb-8">
        <input 
          type="text" 
          name="q" 
          value={q} 
          placeholder="Tapez un mot-clé (ex: IA, mobile, gadget)..." 
          class="flex-1 px-4 py-3 rounded-lg border text-sm"
          style="background: var(--bg-secondary); color: var(--text-primary); border:1px solid var(--border-light);"
        />
        <button 
          type="submit" 
          class="px-6 py-3 rounded-lg font-semibold"
          style="background: var(--accent); color:#fff;"
        >Chercher</button>
      </form>

      {q && (
        <p class="text-sm mb-6" style="color: var(--text-secondary);">
          {results.length} résultat{results.length !== 1 && 's'} pour « {q} »
        </p>
      )}

      {errorMsg && (
        <div class="p-4 rounded-lg mb-6 text-sm" style="background: var(--bg-secondary); color: var(--text-secondary);">
          {errorMsg}
        </div>
      )}

      {!q && (
        <div class="p-8 rounded-lg text-center" style="background: var(--bg-secondary); border:1px solid var(--border-light);">
          <p style="color: var(--text-secondary);">Entrez un mot-clé pour commencer la recherche.</p>
        </div>
      )}

      {q && results.length === 0 && !errorMsg && (
        <div class="p-8 rounded-lg text-center" style="background: var(--bg-secondary); border:1px solid var(--border-light);">
          <p style="color: var(--text-secondary);">Aucun article trouvé. Essayez un autre terme.</p>
        </div>
      )}

      {results.length > 0 && (
        <div class="grid md:grid-cols-2 gap-6">
          {results.map((a: any) => {
            const cSlug = a.article_categories?.[0]?.category?.slug;
            const mapped = cSlug ? mapCategorySlug(cSlug) : '';
            const url = mapped ? `/${mapped}/${a.slug}` : `/${a.slug}`;
            return (
              <a href={url} class="group p-5 rounded-lg transition-colors" style="background: var(--bg-secondary); border:1px solid var(--border-light);">
                <h3 class="font-semibold mb-2 line-clamp-2 group-hover:underline" style="color: var(--text-primary);">{a.title}</h3>
                <div class="flex items-center text-xs gap-3" style="color: var(--text-secondary);">
                  <time datetime={a.created_at}>{new Date(a.created_at).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', year: 'numeric' })}</time>
                  {a.article_categories?.[0]?.category?.name && (
                    <span style="color: var(--accent);">{a.article_categories[0].category.name}</span>
                  )}
                </div>
                {a.excerpt && (
                  <p class="text-sm mt-3 line-clamp-3" style="color: var(--text-secondary);">{a.excerpt}</p>
                )}
              </a>
            );
          })}
        </div>
      )}
    </div>
  </section>
</BaseLayout>
